<!-- templates/analytics.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Analytics Dashboard - Web Crawler Blog</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="{{ 'dark-theme' if session.get('theme') == 'dark' else '' }}">
    <header>
        <h1>Analytics Dashboard</h1>
        <nav>
            <ul>
                <li><a href="{{ url_for('home') }}">Home</a></li>
                <li><a href="{{ url_for('admin') }}">Admin</a></li>
            </ul>
        </nav>
        <button id="toggleTheme">Toggle Theme</button>
    </header>
    <main>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Visit Summary</h3>
                <p>Total Visits: {{ stats.total_visits }}</p>
                <p>Human Visits: {{ stats.human_visits }}</p>
                <p>Crawler Visits: {{ stats.crawler_visits }}</p>
                <p>Average Time on Page: {{ stats.avg_time_on_page }} seconds</p>
                <p>Average Scroll Depth: {{ stats.avg_scroll_depth }}%</p>
                <p>Crawler Percentage: {{ "%.2f"|format(stats.crawler_visits/stats.total_visits*100 if stats.total_visits > 0 else 0) }}%</p>
            </div>
            
            <div class="stat-card">
                <h3>Device Distribution</h3>
                <table class="data-table">
                    <tr>
                        <th>Device Type</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                    {% for device in stats.devices %}
                    <tr>
                        <td>{{ device.device_type or 'Unknown' }}</td>
                        <td>{{ device.count }}</td>
                        <td>{{ "%.2f"|format(device.count/stats.total_visits*100 if stats.total_visits > 0 else 0) }}%</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>

        <div class="stat-card">
            <h3>Top Crawlers</h3>
            <table class="data-table">
                <tr>
                    <th>Crawler Name</th>
                    <th>Visit Count</th>
                    <th>Percentage of Crawler Visits</th>
                </tr>
                {% for crawler, count in stats.top_crawlers %}
                <tr>
                    <td>{{ crawler or 'Unknown' }}</td>
                    <td>{{ count }}</td>
                    <td>{{ "%.2f"|format(count/stats.crawler_visits*100 if stats.crawler_visits > 0 else 0) }}%</td>
                </tr>
                {% endfor %}
            </table>
        </div>

        <div class="stat-card">
            <h3>Most Visited Pages</h3>
            <table class="data-table">
                <tr>
                    <th>Page URL</th>
                    <th>Views</th>
                    <th>Percentage of Total Views</th>
                </tr>
                {% for url, count in stats.top_pages %}
                <tr>
                    <td>{{ url }}</td>
                    <td>{{ count }}</td>
                    <td>{{ "%.2f"|format(count/stats.total_visits*100 if stats.total_visits > 0 else 0) }}%</td>
                </tr>
                {% endfor %}
            </table>
        </div>

        <div class="stat-card">
            <h3>Visitor Trends</h3>
            <canvas id="visitorChart" width="400" height="200"></canvas>
        </div>

        <div class="stat-card">
            <h3>Crawler vs Human Visits</h3>
            <canvas id="crawlerChart" width="400" height="200"></canvas>
        </div>

        <div class="stat-card">
            <h3>Bot Confidence Levels</h3>
            <table class="data-table">
                <tr>
                    <th>Path</th>
                    <th>Average Confidence</th>
                </tr>
                {% for path, avg_conf in stats.avg_bot_confidence %}
                <tr>
                    <td>{{ path }}</td>
                    <td>{{ "%.2f" | format(avg_conf) }}%</td>
                </tr>
                {% endfor %}
            </table>
        </div>

        <div class="stat-card">
            <h3>Real-Time Visitors</h3>
            <p>Active Users: <span id="activeUsers">0</span></p>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"
        integrity="sha512-+Il1HZbXgUfX6/Rp9fnnWm0qC/AZTLOXtsSgc+zpBqkVEsGASnOnid+8sMZgH6C/qGXQleIZDnvY4p3FfETeAQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // Theme Toggle
        $('#toggleTheme').click(function() {
            $('body').toggleClass('dark-theme');
            const newTheme = $('body').hasClass('dark-theme') ? 'dark' : 'light';
            
            // Save preference via AJAX
            $.ajax({
                url: '/api/set_theme',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ theme: newTheme }),
                success: function() {
                    console.log('Theme updated.');
                }
            });
        });

        // Real-Time Visitor Tracking
        var socket = io();

        socket.on('connect', function() {
            console.log('Connected to server for real-time updates.');
        });

        socket.on('update_users', function(data) {
            $('#activeUsers').text(data.active_users);
        });

        // Charts with Chart.js
        const ctx = document.getElementById('visitorChart').getContext('2d');
        const visitorChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ stats.dates | tojson }},
                datasets: [{
                    label: 'Visits',
                    data: {{ stats.visit_counts | tojson }},
                    backgroundColor: 'rgba(52, 152, 219, 0.2)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1,
                    fill: true,
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        const ctx2 = document.getElementById('crawlerChart').getContext('2d');
        const crawlerChart = new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: ['Human Visits', 'Crawler Visits'],
                datasets: [{
                    data: [{{ stats.human_visits_count }}, {{ stats.crawler_visits_count }}],
                    backgroundColor: [
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(231, 76, 60, 0.7)'
                    ],
                    borderColor: [
                        'rgba(46, 204, 113, 1)',
                        'rgba(231, 76, 60, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
            }
        });

        // JavaScript Enabled Cookie
        document.cookie = "js_enabled=true; path=/";
    </script>
</body>
</html>
